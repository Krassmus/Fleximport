# HisInOne Import mit Fleximport

HisInOne ist ein großes deutsches Campus-Management-System, das oft in Kombination mit Stud.IP verwendet wird. Ein großes Projekt ist es gewesen, ein HisInOne über Fleximport mit Stud.IP zu koppeln. Das ist möglich, aber es ist auch viel zu konfigurieren. Daher gibt es hier eine Anleitung dazu.

## Installation

1. Installation von Fleximport im Stud.IP. Das Plugin muss mindestens den Root-Usern in Stud.IP zugänglich sein. Der Import ist ab Stud.IP 4.5 getestet und sollte für neuere Versionen von Stud.IP funktionieren. Fleximport selbst gibt es für ältere Stud.IPs auch und vermutlich wird das meiste auch für 4.0 aufwärts funktionsfähig sein. Aber es können trotzdem Teile des Imports wie die Modulstrukturen für ältere Stud.IP-Versionen schwierig bis unmöglich sein.
2. In HisInOne muss ein Zusatzservice zur Orchestrierung der Webservices von HisInOne installiert und einsatzfähig sein.
3. Als Root in Stud.IP angemeldet, geht man zum Fleximport (zum Beispiel über die Startseite im Schnellzugriff ganz unten, Fleximport kann aber auch so konfiguriert sein, dass er in der Kopfzeile auftaucht).
4. In der Sidebar klickt man auf *"Prozess importieren"*. Hier muss eine Datei mit der Endung `.flxip` importiert werden. Für HisInOne haben wir da schon mal etwas vorbereitet: [HisInOne Import.flxip](examples/HisInOne Import.flxip) . Die Datei kann [hier](examples/HisInOne Import.flxip) heruntergeladen werden oder sie befindet sich auch im Pluginverzeichnis von Fleximport im Ordner examples.
5. Jetzt klickt man auf *"Prozess bearbeiten"* in der Sidebar. Dort kann man den Prozess / Reiter in Fleximport umbenennen. Aber wichtiger ist es, dass man dort unter Konfigurationen den Wert für `HISINONE_TERMKEY` setzt, der für das Semester gilt, das man importieren will. Das sind die IDs der Semester in HisInOne wie 202101 für das Sommersemester 2021. Die ersten vier Stellen sind das Jahr, an dem das Semester anfängt. Dahinter gibt es noch eine 1 für das Sommersemester und eine 0 für das Wintersemester. In diesem Dialog kann man auch einzelne Tabellen deaktivieren, falls man zum Beispiel die Modulstrukturen nicht importiert haben möchte. Aber wir gehen erst einmal davon aus, dass das volle Programm gewünscht ist. Nicht vergessen, auf *Speichern* zu klicken!
6. Jetzt kommt noch die Verknüpfung zwischen HisInOne und Stud.IP. Dazu klickt man auf den Reiter *Konfiguration*. Auf dieser Seite kann man etliche Konfigurationsvariablen setzen, die für den Fleximport in irgendeiner Weise relevant sind. Ganz wichtig und relevant sind auf jeden Fall die Zugangsdaten zu den Webservices von HisInOne, damit Fleximport sich die Daten der Veranstaltungen und Personen und dem ganzen Rest abholen kann. Wichtig ist dabei der Wert `HISINONE_WSDL_URL`, der eine URL zu einer WSDL-Datei von HisInOne und in der Form `https://hisinone.MEINEHOCHSCHULEPLATZHALTER.de/qisserver/services2/StudIPService?wsdl` sein sollte. Diese URL muss nicht im ganzen Internet aber auf jeden Fall vom Stud.IP aus gesehen erreichbar sein. Am Ende dieser Datei gibt es eine Angabe zur `Location` (`<soap:address location="eine url">`). An dieser Stelle ist es sinnvoll sicherzugehen, dass die dort angebene URL ebenfalls vom Stud.IP-Server aus aufgerufen werden kann. Angaben wie `http://localhost/...` sind mit Sicherheit nicht korrekt.
7. Weitere Angaben sind der Nutzername und der Passwort des virtuellen Nutzers, der auf die Webservices von HisInOne zugreifen darf. Haben Sie noch keinen derartigen Nutzer, müssen Sie zuerst einen in HisInOne anlegen. In dem Reiter Konfiguration von Fleximport trägt man diesen Nutzernamen und Passwort ein als `HISINONE_SOAP_USERNAME` und `HISINONE_SOAP_PASSWORD`.
8. Als letzte der absolut wichtigen Angaben muss hier der `HISINONE_SOAP_ENDPOINT` gesetzt werden als eine URL in der Art `https://hisinone.MEINEHOCHSCHULEPLATZHALTER.de/qisserver/services2/`.

Ab jetzt sollte die Verbindung zwischen Stud.IP und HisInOne funktionieren. Um das zu testen, geht man zurück auf den Reiter *"HisInOne Import"* (bzw. wie man den Prozess genannt hat, den man zuvor importiert hat). Und dort klickt man in der Sidebar oder ganz unten auf der Seite auf den Button *"Daten abrufen"*. Das kann etwas dauern. Um genau zu sein, kann es sogar sehr lange dauern. Eine Stunde ist nicht ungewöhnlich, aber es kann auch mehr oder weniger dauern. Eventuell zeigt der Fleximport auch einen Statusbalken an, der den Fortschritt des Datenabrufens darstellt. Aber Fleximport kann nur grob den Fortschritt messen. Es ist eher ein ungefährer Hinweis darauf, wieviele Kaffees man sich voraussichtlich kochen kann, bis die Daten da sind.

Wenn dies hier so lange dauert, dass es zu einem Timeout kommt, kann man im Reiter *"Konfiguration"* einen neuen Wert `MAXIMUM_EXECUTION_TIME` eintragen mit dem Wert 7200, was zwei Stunden entspricht (man kann natürlich auch eine höhere oder niedrigere Zahl angeben). `MAXIMUM_EXECUTION_TIME` ist immer eine Zahl, die angibt, wie viele Sekunden der Import maximal dauern kann. Falls dennoch ein Timeout kommt (und vor dem Ablauf der angegebenen zwei Stunden), müsste man den Webserver wie Apache oder NGINX (bzw. PHP oder einen vorgeschalteten Proxy) so konfigurieren, dass Timeouts grundsätzlich durchaus lang sein können. Es gibt sehr viele Stellen in der Serverinfrastruktur, bei denen sich ein Timeout noch verstecken könnte. `MAXIMUM_EXECUTION_TIME` überschreibt nur mit der Funktion `set_time_limit` den Timeout `max_execution_time` von PHP - die anderen Timeouts würden dennoch gelten und müssen entsprechend angepasst werden.

## Mapping der Einrichtungen

Zu diesem Zeitpunkt kommen alle Daten aus HinInOne an und wir können mit Fleximport weiter arbeiten. Die vorhin importierte Datei für den Prozess sollte die meisten Mappings schon enthalten, aber einige Mappings müssen noch umgestellt werden, weil die in jedem System anders sein können. Das betrifft vor allem Datenfelder.

Aber der Reihe nach: In HinInOne haben Entitäten wie Fakultäten und Einrichtungen eine ID. Wenn die Daten nach Stud.IP kommen, werden sie das erste Mal importiert also neu erstellt. Aber in den meisten Stud.IPs sind die Fakultäten und Einrichtungen ja schon vorhanden. Da will niemand, dass sie nach einem Import zweimal vorhanden sind. Und schlimmer noch, wenn der Import jede Nacht einmal automatisch ausgeführt wird, will man ja nicht jede Nacht jede Fakultät ein weiteres Mal im System auftauchen sehen. Daher braucht der Fleximport eine Möglichkeit, die Entitäten von HisInOne mit den Identitäten, die es in Stud.IP schon gibt, zu identifizieren. Das geht natürlich und muss per Mapping eingestellt werden. Dazu arbeitet man mit den IDs, die es in HisInOne gibt.

Diese IDs werden in einem ersten Schritt den Entitäten in Stud.IP zugewiesen. Also ganz konkret muss die *Fakultät für Mathematik* in Stud.IP die ID der *Fakultät für Mathematik* aus HisInOne bekommen. Diese ID ist beispielsweie 13. Irgendwo in Stud.IP muss also der *Fakultät für Mathematik* die 13 als ID des Fremdsystems zugewiesen werden. Eine gute Idee wäre es, diese 13 in ein sogenanntes freies Datenfeld einzutragen. Dazu muss man jetzt in Stud.IP allerdings erst einmal [ein Datenfeld anlegen](https://hilfe.studip.de/admin/GlobaleEinstellungen/Datenfelder), das vielleicht `hisinone_id` heißt. Außer von Root muss dieses Datenfeld nicht sichtbar oder editierbar sein. Es dient ja allein technischen Zwecken.

Man könnte jetzt in alle Einrichtungen diese IDs von Hand eintragen. Aber Fleximport kann das auch übernehmen, **sofern die Einrichtungen in HisInOne und Stud.IP schon dieselben Namen haben** und diese auch schon eindeutig sind.

Dazu klickt man auf *"Prozess bearbeiten"* und bei *"Tabellen aktivieren"* wählt man alle Tabellen ab außer die erste `fleximport_hisinone_a_institutes` und speichert. Danach sollte nur noch eine Tabelle da sein. In der Tabelle suchen wir jetzt eine bestimmte Einrichtung aus HisInOne, die gewissermaßen eine Übereinrichtung für unsere Fakultäten in Stud.IP sind. Diese steht vermutlich sogar in der ersten Zeile. Aber wenn nicht, findet man sie, indem man eine Fakultät nimmt, diese in der Tabelle sucht und die Spalte `fakultaet_lid` heraussucht. Dies ist eine Zahl. Jetzt sucht man diese Zahl in der Spalte `lid` und findet eine einzige Zeile, in der diese `lid` steht. Das sollte die Übereinrichtung sein, die wir streng genommen gar nicht in Stud.IP haben möchten. Jetzt merken wir uns diese `lid` der Übereinrichtung, gehen auf den Reiter *"Konfiguration"* und tragen diese Zahl bei `HISINONE_VIRTUAL_INSTITUT_ROOT_LID` ein. Jetzt können wir noch einmal zum Reiter *"HisInOne Import"* zurück kehren und noch einmal auf *"Daten abrufen"* klicken.

Jetzt sollte die Zeile der Übereinrichtung in der Tabelle nicht mehr auftauchen. Und generell könnten jetzt alle Zeilen einen dicken blauen Haken am Anfang und keine Fehler (rotes X) mehr stehen haben.

Nun haben wir noch eine Sache zu erledigen: Wir müssen die IDs in die Datenfelder mappen. Dazu klicken wir auf das Kettensymbol oben rechts von der Tabelle. Dort wird das Mapping der Daten eingestellt. In der im Dialog auftauchenden Tabelle sollte unten die vorletzte Zeile jenes Datenfeld sein, das wir vorhin angelegt haben. Dort wollen wir die `lid` aus HisInOne eintragen. Also wählen wir in der Zeile in der Auswahlbox `lid` aus. Das bedeutet nun, dass die `lid` aus den Daten in das neue Datenfeld `hisinone_lid` eingetragen wird, sowie der Import durchgeführt wird. Nicht vergessen, auf *"Speichern"* zu klicken.

Jetzt sollte die Tabelle ordentlich aussehen und alle Daten würden ordnungsgemäß eingetragen. Lassen Sie sich noch einmal alle Daten anzeigen, klicken Sie auch einmal auf die blauen Haken am Anfang einer Zeile. Damit bekommt man eine Übersicht, welche Daten sich verändern würden, wenn man jetzt importieren würde, wobei das natürlich alles Rohdaten der Datenbank sind. Wenn jetzt alles einmal gut und sinnvoll aussieht und die Fehler sich im Rahmen halten, können Sie jetzt endlich auf *"Import starten"* klicken und bestätigen. Wenn nur eine Tabelle zu sehen ist, wird nur diese eine Tabelle, nämlich die Einrichtungsdaten, importiert. Zeilen dieser Tabelle, die ein rotes X haben, werden nicht importiert werden. Sie können mit der Maus über das rote X fahren; Fleximport zeigt Ihnen dann den Grund an, was mit dem Datensatz falsch ist.

Die Daten sind jetzt in Stud.IP. Und ganz wichtig dabei: Die IDs der Einrichtungen, die `lid` bzw. `hisinone_lid`, ist für die Einrichtungen eingetragen. Eine Sache ist nach dem Import jetzt noch zu tun: Gehen wir wieder auf das Mapping oben rechts mit dem Kettensymbol. Dort ändern wir wieder in der Tabelle die erste Zeile `institut_id` die Auswahlbox auf *"Von Datenfeld 'hisinone_lid' ermitteln"*. Darunter ist noch eine Auswahlbox, in der wir `lid` auswählen. Damit sagen wir Fleximport, dass wir die Einrichtungen ab jetzt nicht mehr über den Namen identifizieren, denn auch der Name einer Fakultät kann sich ja mal ändern, sondern über die `lid` und wir sagen Fleximport auch, dass diese `lid` sich im Datenfeld `hisinone_lid` der Einrichtung versteckt. Damit hat Fleximport alle Informationen, um die Datensätze aus HisInOne mit den Einrichtungen in Stud.IP zu verknüpfen und weiß immer, was es aktualisieren soll.


